<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>خواندن فصل</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header id="reader-header" style="position:fixed; top:0; left:0; right:0; height:60px; background:#1a1a1a; display:flex; align-items:center; justify-content:space-between; padding:0 20px; z-index:100; transition:all 0.3s;">
  <div onclick="history.back()" style="cursor:pointer; color:#ffd700; font-size:1.5rem;">← بازگشت</div>
  <div style="color:#ffd700;">
    امتیاز: <span id="score-value">20</span>
  </div>
</header>

<main class="reader-container" id="reader-main" style="padding:80px 10px 120px;">
  <div id="loading" style="text-align:center; color:#ffd700; padding:200px 20px;">در حال بارگذاری فصل...</div>
</main>

<!-- ناوبری فصل‌ها -->
<div id="chapter-nav-wrapper" style="position:fixed; bottom:0; left:0; right:0; background:rgba(0,0,0,0.9); padding:15px 10px; border-top:1px solid #444; z-index:90; overflow-x:auto; white-space:nowrap; text-align:center;">
  <div id="chapter-nav" style="display:inline-flex; gap:14px; justify-content:flex-start;"></div>
</div>

<script src="adivery.global.js"></script>
<script src="data.js"></script>
<script src="storage.js"></script>
<script src="ads.js"></script>

<script>
// بروزرسانی امتیاز
function updateScore() {
  const score = window.getScore ? window.getScore() : 20;
  document.getElementById('score-value').textContent = score;
}

// immersive mode
let isImmersive = false;
document.addEventListener('click', e => {
  if (e.target.tagName === 'IMG' || e.target.id === 'reader-main') {
    isImmersive = !isImmersive;
    document.body.classList.toggle('immersive', isImmersive);
    document.getElementById('reader-header').style.opacity = isImmersive ? '0' : '1';
    document.getElementById('chapter-nav-wrapper').style.opacity = isImmersive ? '0' : '1';
  }
});

window.addEventListener('load', () => {

  const params = new URLSearchParams(location.search);
  const comicId = parseInt(params.get('comic'));
  const chapterId = parseInt(params.get('chapter') || '1');

  if (isNaN(comicId) || isNaN(chapterId)) {
    document.body.innerHTML = "<h1 style='text-align:center; color:red; margin:200px 20px;'>آیدی نامعتبر</h1>";
    return;
  }

  const comic = comics.find(c => c.id === comicId);
  if (!comic) {
    document.body.innerHTML = "<h1 style='text-align:center; color:red; margin:200px 20px;'>کمیک یافت نشد</h1>";
    return;
  }

  const chapter = comic.chapters.find(ch => ch.id === chapterId);
  if (!chapter) {
    document.body.innerHTML = "<h1 style='text-align:center; color:red; margin:200px 20px;'>فصل یافت نشد</h1>";
    return;
  }

  // چک امتیاز
  const canRead = window.spendScoreIfNeeded ? window.spendScoreIfNeeded(comicId, chapterId) : true;
  if (!canRead) {
    alert("امتیاز کافی نیست!");
    history.back();
    return;
  }

  document.getElementById('loading').remove();

  const main = document.getElementById('reader-main');
  chapter.pages.forEach((url, i) => {
    const img = document.createElement('img');
    img.src = url;
    img.alt = "صفحه " + (i+1);
    img.style.cssText = "width:100%; display:block; margin-bottom:2px;";
    main.appendChild(img);
  });

  // ناوبری فصل‌ها
  const nav = document.getElementById('chapter-nav');
  comic.chapters.forEach(ch => {
    const btn = document.createElement('button');
    btn.textContent = ch.id;
    btn.style.cssText = `
      width:54px; height:54px; border-radius:50%; 
      background:${ch.id === chapterId ? '#ffd700' : 'rgba(255,215,0,0.18)'}; 
      color:${ch.id === chapterId ? '#000' : '#ffd700'}; border:none; 
      font-weight:bold; font-size:1.3rem; cursor:pointer; 
      transition:all 0.25s; box-shadow:0 3px 10px rgba(0,0,0,0.4);
    `;

    btn.onclick = () => {
      location.href = `reader.html?comic=${comic.id}&chapter=${ch.id}`;
    };

    nav.appendChild(btn);
  });

  updateScore();
});
</script>

<style>
.immersive #reader-header,
.immersive #chapter-nav-wrapper {
  opacity: 0;
  pointer-events: none;
}
</style>

</body>
</html>